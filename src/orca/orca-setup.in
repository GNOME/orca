#!@PYTHON@
#
# Orca
#
# Copyright 2004-2005 Sun Microsystems Inc.
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Library General Public
# License as published by the Free Software Foundation; either
# version 2 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Library General Public License for more details.
#
# You should have received a copy of the GNU Library General Public
# License along with this library; if not, write to the
# Free Software Foundation, Inc., 59 Temple Place - Suite 330,
# Boston, MA 02111-1307, USA.

"""Permits the user to set up preferences for orca using speech prompts
and a command line interface.
"""

import os, commands, sys, time
from orca.orca_i18n import _  # for gettext support

# Create the user's .orca directory
#
orcadir = os.path.join (os.environ["HOME"], ".orca")
try:
    os.chdir (orcadir)
except:
    print _("Creating .orca directory.")
    try:
        os.mkdir (orcadir)
    except:
        # [[[TODO: WDW - need to print a message and fail here.]]]
        #
        pass
        
# Create a new settings file
#
settingsFileName = os.path.join (orcadir, "user-settings.py")
settings = open (settingsFileName, "w")
settings.writelines ("# user-settings.py - custom Orca settings\n")
settings.writelines ("# Initially generated by orca-setup\n")
settings.writelines ("\n")
settings.writelines ("import orca.debug as debug\n")
settings.writelines ("import re\n")
settings.writelines ("\n")
settings.writelines ("#debug.setDebugLevel(debug.LEVEL_FINER)\n")
settings.writelines ("#debug.setEventDebugFilter(None)\n")
settings.writelines ("#debug.setEventDebugFilter(re.compile('[\S]*focus|[\S]*activ'))\n")
settings.writelines ("#debug.setEventDebugFilter(re.compile('nomatch'))\n")
settings.writelines ("#debug.setEventDebugFilter(re.compile('[\S]*:accessible-name'))\n")
settings.writelines ("#debug.setEventDebugLevel(debug.LEVEL_OFF)\n")

settings.writelines ("\n")

# Speech setup
#
import orca.speech as speech
import orca.speechserver as speechserver


def sayAndPrint (text, 
                 stop=False, 
	         getInput=False,
		 speechserver=speech, 
                 acssName="default"):
    """Prints the given text.  In addition, if the setupSpeaker field
    is not None, speaks the given text, optionally interrupting
    anything currently being spoken.
    
    Arguments:
    - text: the text to print and speak
    - stop: if True, interrupt any speech currently being spoken
    - getInput: if True, elicits raw input from the user and returns it

    Returns raw input from the user if getInput is True.
    """
    
    if stop:
	speech.stop()
    	speechserver.stop()
    speechserver.speak(text, acssName)

    if getInput:
        return raw_input(text)
    else:
        print text        


def setupSpeech ():
    """Sets up speech support.  If speech setup is successful and the
    user wants it, writes speech settings to the setting file and returns
    True.  If speech is not available, or the user doesn't want speech,
    returns False.
    """
    
    factories = speech.getSpeechServerFactories()
    if len(factories) == 0:
        print _("No working speech drivers found.")
        return False

    speech.init()
    speech.speak(_("Welcome to Orca setup."))
    speech.speak(_("Select default speech synthesizer."))

    servers = {}
    i = 1
    for factory in factories:
	for server in factory.SpeechServer.getSpeechServers():
	    sayAndPrint(_("%d. %s") % (i, server.getInfo()[1]))
	    servers[i] = [factory, server]
	    i += 1

    choice = int(sayAndPrint(_("Enter choice: "), False, True))
    if (choice <= 0) or (choice >= i):
        sayAndPrint(_("Speech will not be used.\n"))
        return False

    [factory, server] = servers[choice]

    sayAndPrint (_("Select %s voice: ") % server.getInfo()[1], True)
    voices = {}    
    i = 1
    for family in server.getVoiceFamilies():
        name = family[speechserver.VoiceFamily.NAME]
        acss = speechserver.ACSS({speechserver.ACSS.FAMILY : family})
        server.setACSS(name, acss)
        sayAndPrint(_("%d. %s") % (i, name))
	voices[i] = acss
	i += 1

    selection = int(sayAndPrint(_("Enter choice: "), False, True))
    if selection == 0 or selection >= i:
        speech.speak(_("Speech will not be used.\n"))
        return False

    defaultACSS = voices[selection]
    
    pitch = defaultACSS[speechserver.ACSS.AVERAGE_PITCH] * 1.5
    uppercaseACSS = speechserver.ACSS(defaultACSS)
    uppercaseACSS[speechserver.ACSS.AVERAGE_PITCH] = pitch

    voices = {
        "default"   : [factory.__name__, server.getInfo()[0], defaultACSS],
        "uppercase" : [factory.__name__, server.getInfo()[0], uppercaseACSS]
    }
        
    settings.writelines ("voices = " + str(voices)+"\n")

    keyEcho = sayAndPrint (_("Use key echo?  Enter y or n: "), True, True)
    if keyEcho[0:1] == 'Y' or keyEcho[0:1] == 'y':
        settings.writelines ("keyEcho = True\n")
    else:
        settings.writelines ("keyEcho = False\n")

    settings.writelines ("useSpeech = True\n")
    return True


def setupBraille ():
    """Sets up Braille support.  If Braille is available and the user
    wants it, returns True.  If Braille is unavailable or the user
    doesn't want it, returns False.
    """
    
    working = False
    try:
        import orca.braille as braille
        working = braille.init ()
	braille.shutdown ()
    except:
        pass

    if working:
        useBraille = sayAndPrint (
            _("Braille support appears to work, use it?  Enter y or n. "),
            False,
            True)

        if useBraille[0:1] == 'Y' or useBraille[0:1] == 'y':
            return True
        else:
            return False
    else:
        return False


def enableAccessibility():
    """Enables the GNOME accessibility flag.  Users need to log out and
    then back in for this to take effect."""

    alreadyEnabled = commands.getoutput(\
	"gconftool-2 --get /desktop/gnome/interface/accessibility")
    if alreadyEnabled != "true":
        os.system("gconftool-2 --type bool --set " \
		  + "/desktop/gnome/interface/accessibility true")

        sayAndPrint("Accessibility support for GNOME has been enabled.")
        sayAndPrint("You need to log out and log back in for the change "\
                    +"to take effect.")


useSpeech = setupSpeech ()
if useSpeech == False:
    settings.writelines ("useSpeech = False\n")
    settings.writelines ("keyEcho = False\n")
    
useBraille = setupBraille ()
if useBraille:
    settings.writelines ("useBraille = True\n")
else:
    settings.writelines ("useBraille = False\n")

enableAccessibility()

sayAndPrint ("Orca setup finished.\n", True)
